Про
ГОСТовский
шифр
Кузнечик
его
SBox
и
потерянные
сиды
/
Хабр
β
Рейтинг
Мы
превращаем
программистов
в
криптографов
июн
в
:
Про
ГОСТовский
шифр
Кузнечик
его
SBox
и
потерянные
сиды
мин
K
Привет
%username%!
Недавно
мы
вернулись
с
конференции
EuroCrypt
где
познакомились
с
чрезвычайно
умными
людьми
и
заодно
узнали
новые
чрезвычайно
обидные
факты
о
ГОСТовском
SBox
Так
что
это
второй
подход
к
снаряду
Исправленный
и
дополненный
В
этот
раз
не
будет
непонятных
красно-синих
слайдов
зато
будут
оригинальные
документы
из
комитета
ISO
c
объяснениями
авторов
Кузнечика
И
даже
челлендж
в
конце!
Поехали
Вначале
ликбез
В
предыдущей
статье
его
не
было
в
этот
раз
исправляюсь
Chosen
Plaintext
Attack
(CPA)
Начнем
мы
с
базовой
модели
атаки
на
блочные
шифры
В
этой
модели
атакующий
знает
о
криптосистеме
всё
кроме
ключа
шифрования
Он
может
создавать
любые
открытые
тексты
получать
соответствующие
им
шифротексты
и
его
задачей
является
вычислить
ключ
т
к
это
единственная
переменная
Блочный
шифр
в
данной
ситуации
можно
рассматривать
как
псевдослучайную
подстановку
Функцию
которая
блоку
открытого
текста
сопоставляет
блок
шифротекста
таким
образом
что
связь
между
ними
определить
невозможно
Идеальный
блочный
шифр
можно
представить
себе
как
большую
таблицу
где
по
горизонтали
будут
все
возможные
ключи
от
до
по
вертикали
—
все
возможные
открытые
тексты
тоже
от
до
а
на
месте
их
пересечения
—
случайным
образом
сгенерированные
шифротексты
которые
однозначно
связывали
бы
пару
«ключ
—
открытый
текст»
Создать
такую
таблицу
в
реальной
жизни
не
представляется
возможным
из-за
её
размеров
поэтому
её
эмулируют
с
помощью
различных
алгоритмов
блочного
шифрования
Атаку
на
блочный
шифр
можно
назвать
успешной
если
мы
можем
определить
«неслучайность»
с
которой
алгоритм
выбирает
шифротексты
соответствующие
открытым
текстам
Эта
неслучайность
и
позволяет
в
самых
худших
случаях
вычислить
ключ
шифрования
(Не)линейность
Процесс
шифрования
в
блочном
шифре
можно
представить
простой
формулой
C
=
M
х
K
где
C
—
шифротекст
M
—
открытый
текст
K
—
ключ
шифрования
а
x
—
блочный
шифр
Эта
формула
визуально
похожа
на
школьную
формулу
линейного
уравнения
y
=
kx+b
графиком
которой
является
прямая
линия
Любую
прямую
линию
можно
восстановить
всего
по
двум
точкам
И
в
то
же
время
мы
очень
не
хотим
чтобы
по
двум
парам
открытый
текст
—
шифротекст
можно
было
восстановить
ключ
шифрования
Для
этого
в
алгоритмы
шифрования
добавляют
специальные
прослойки
отвечающие
за
нелинейность
Эти
прослойки
призваны
не
допустить
возможность
вычисления
связи
между
открытым
текстом
шифротекстом
и
ключом
Их
качество
критически
важно
для
безопасности
алгоритма
Что
такое
SBox?
Это
та
самая
нелинейная
прослойка
Функция
которая
в
случае
Кузнечика
и
некоторых
других
шифров
однозначно
сопоставляет
одному
байту
другой
байт
Очень
часто
она
задаётся
простой
таблицей
соответствия
например
такой:
Потому
что
иначе
её
не
описать
На
первый
взгляд
Почему
SBox
важен?
Потому
что
это
единственная
нелинейная
функция
во
всём
шифре
Без
неё
взломать
шифр
будет
не
просто
а
очень
просто
представив
его
в
виде
системы
линейных
уравнений
Поэтому
к
функции
подстановки
так
много
внимания
Есть
даже
по
взлому
AES
с
линейным
SBox
Почему
нельзя
создать
один
безопасный
SBox
на
всех?
Проблема
в
том
что
криптография
не
является
точной
наукой
Единственным
доказуемо
стойким
алгоритмом
шифрования
является
Всё
остальное
—
робкие
попытки
уместиться
в
диапазон
доступных
нам
знаний
набор
которых
не
так
уж
велик
Мы
точно
не
знаем
стоек
ли
RSA
или
AES
или
эллиптические
кривые
но
мы
знаем
что
такие-то
и
такие-то
вещи
делать
точно
нельзя
Всё
что
между
—
творчество
Отсюда
и
постоянная
паранойя
по
поводу
различных
«магических
констант»
и
прочих
моментов
которые
авторы
алгоритмов
преподносят
как
безопасные
но
не
могут
это
доказать
Как
создают
SBox?
Различных
вариантов
SBox
—
!
это
примерно
Выбор
большой
и
за
годы
криптоанализа
были
выработаны
метрики
и
характеристики
которыми
должен
обладать
SBox
стойкий
к
известным
на
сегодня
атакам
Конечно
создатели
таблиц
думают
на
годы
вперед
и
пытаются
создать
подстановки
которые
были
бы
стойки
даже
к
атакам
придуманными
через
-
лет
Но
это
уже
больше
из
разряда
магии
и
шаманства
Есть
два
принципиально
разных
подхода
к
созданию
SBox
Первый
—
случайный
поиск
Разработчики
генерируют
случайные
таблицы
смотрят
на
их
характеристики
и
отсеивают
те
которые
не
подходят
Так
продолжается
до
тех
пор
пока
разработчики
не
удовлетворятся
найденным
В
цивилизованном
мире
это
происходит
например
следующим
образом:
Так
любой
может
воспроизвести
этот
процесс
и
убедиться
что
были
соблюдены
хотя
бы
минимальные
требования
к
псевдослучайному
поиску
Знаете
куда
делись
сиды
от
главного
симметричного
алгоритма
страны?
Потерялись!
Я
думал
их
специально
не
выдают
секрет
там
или
что
но
российские
коллеги
на
EuroCrypt
рассказали
что
во
время
разработки
алгоритма
в
м
году
никто
почему-то
не
думал
что
придётся
обосновывать
дизайн
таблицы
подстановок
и
значения
из
которых
она
получилась
были
навсегда
утеряны
История
красивая
вот
только
не
стоит
забывать
что
алгоритм
создавался
не
в
школе
на
перемене
а
в
недрах
ФСБ
Второй
способ
—
создать
SBox
самим
руководствуясь
доступным
математическим
аппаратом
Так
авторы
AES
и
у
них
неплохо
получилось
Если
сравнить
нелинейность
SBox
AES
SM
(китайский
стандарт)
и
Кузнечика
(он
использует
тот
же
SBox
что
и
хэш
Стрибог)
то
результат
будет
не
в
пользу
последнего
AES
non-linearity
(min
max)
=
(
)
SM
non-linearity
(min
max)
=
(
)
Streebog
non-linearity
(min
max)
=
(
)
Код
вычисления
нелинейности
использует
Walsh
Transform
и
доступен
Документы
В
моё
распоряжение
попали
два
документа
из
ISO
В
дизайнеры
Кузнечика
объясняют
как
создавали
SBox
в
комитет
обсуждает
их
доводы
из
первого
документа
нам
интересны
две
цитаты:
и
Надеюсь
тема
с
«Лео
Перрин
сам
придумал
что
авторы
искали
SBox
случайным
образом»
теперь
закрыта
Из
объяснений
дизайнеров
следует
что
И
вот
в
этом
месте
они
капитально
облажались
Что
такое
структура?
Структура
применительно
к
таблице
подстановки
—
некий
алгоритм
который
эту
таблицу
описывает
В
документе
был
упомянут
AES
Но
таблица
подстановки
для
AES
была
изначально
создана
не
случайным
поиском
а
с
помощью
нескольких
математических
приёмов
позволивших
описать
нелинейный
слой
В
этом
кстати
уникальность
AES
Напротив
если
вы
ищите
SBox
случайным
образом
то
таких
структур
в
нём
быть
не
должно
и
проблема
с
SBox
Кузнечика
в
том
что
слова
дизайнеров
алгоритма
очень
сильно
расходятся
с
фактами
Про
саму
структуру
кузнечика
под
названием
TKLog
я
писал
в
в
этот
раз
поговорим
о
структурах
вообще
Колмогоровская
сложность
Это
результат
исследований
из
Лео
Перрина
на
тему
Кузнечика
Основной
контраргумент
к
статьям
про
структуры
в
SBox
Кузнечика
в
том
что
«практически
в
любом
SBox
можно
найти
какую-то
структуру
если
захотеть»
И
«хоть
вероятность
нахождения
структуры
которую
нашел
Лео
ничтожна
мала
если
бы
был
другой
SBox
то
нашлась
бы
другая
тоже
с
ничтожной
вероятностью»
Допустим
это
так
Но
Как
оказалось
можно
вывести
некую
«степень
заструктурированности»
SBox
которая
не
зависит
от
вероятности
попадания
в
ту
или
иную
структуру
Зато
она
зависит
от
размера
алгоритма
который
нужен
для
генерации
данного
SBox!
Это
и
называется
Колмогоровской
сложностью
Если
представить
SBox
как
строку
байт
то
в
случае
случайной
строки
не
должно
быть
алгоритма
который
генерирует
эту
строку
и
при
этом
сам
меньше
этой
строки
Применительно
к
кузнечику
Итак
размер
SBox
—
байт
Перед
вами
читабельная
версия
кода
авторства
Лео
Перрина
которая
реализует
таблицу
Кузнечика
На
входе
—
исходный
байт
на
выходе
—
соответствующий
ему
байт
из
SBox
Кузнечика
Главным
условием
для
такого
алгоритма
является
запрет
на
использование
языковых
или
платформенных
структур
читерски
сокращающих
размер
программы
К
примеру
если
где-то
внутри
стандартной
библиотеки
есть
константа
содержащая
половину
SBox
то
использовать
её
нельзя
Челлендж
—
написать
программу
размер
которой
будет
меньше
чем
SBox
unsigned
char
p(unsigned
char
x){

unsigned
char

s[]={
}


k[]={
};


if(x)
{

unsigned
char
l=
a=
;

while(a!=x)
{

a=(a<<
)^(a>>
)*
;

l++;

}

if
(l%
)
return
^k[l%
]^s[l/
];

else
return
^k[l/
];

}

else
return
;
}

Наша
задача
показать
что
в
SBox
Кузнечика
заложена
«сильная»
структура
такая
что
её
размер
сильно
меньше
размера
самого
SBox
Код
выше
занимает
символов
что
пока
многовато
Если
упаковать
константы
в
символы
юникода
и
избавиться
от
некоторой
красоты
то
получится
следующий
код:
p(x){

unsigned
char

*t="@`rFTDVbpPBvdtfR@\xacp?\xe
>
\xa
\xe
{z\xe
q
\xa
\xe
"


a=
l=
b=
;

while(x
&&
(l++
a^x))
a=
*a^a/
*
;

return
l%b
?
t[l%b]^t[b+l/b]^b
:
t[l/b]^
;
}

Этот
исходник
занимает
уже
байт
что
уже
на
%
меньше
чем
сам
SBox
Но
мы
идём
дальше
Если
убрать
лишние
пробелы
и
переносы
строк
то
лучшая
на
сегодняшний
день
рабочая
версия
С
кода
выглядит
так:
p(x){char*k="@`rFTDVbpPBvdtfR@\xacp?\xe
>
\xa
\xe
{z\xe
q
\xa
\xe
";int
l=
b=
;while(--l*x^l)x=
*x^x/
*
;return
l%b?k[l%b]^k[b+l/b]^b:k[l/b]^
;}

Чтобы
вывести
на
экран
SBox
можно
воспользоваться
следующим
простым
кодом:
int
main()
{

for(int
i
=
;
i
<
;
i++){

if
(i
%
==
){

printf("\n");

}

printf("%d
"
(unsigned
char)p(i));


}
}

Можете
запустить
и
убедиться
что
код
действительно
работает
и
соответствует
SBox
Кузнечика
Эта
версия
С
кода
занимает
символа
Поскольку
все
символы
кода
—
валидные
ANSI
то
можно
считать
каждый
символ
равным
битам
а
не
Таким
образом
имеем
бит
или
~
байта
А
это
уже
почти
половина
от
размера
таблицы
хоть
и
всё
еще
текстовый
исходник
Что
касается
скомпилированного
кода
то
для
архитектуры
Cortex-M
Лео
удалось
скомпилировать
код
размером
всего
байт
(ассемблерный
код
есть
в
статье)
Это
тоже
не
предел
уже
есть
рабочие
имплементации
размером
меньше
чем
байта
И
что
это
означает
бекдор?
Нет
мы
не
можем
говорить
о
наличие
бекдора
в
Кузнечике
пока
он
не
будет
стопроцентно
найден
Но
и
структура
в
раза
меньшая
чем
Sbox
не
может
попасть
в
SBox
случайно
что
бы
там
ни
говорили
авторы
и
защитники
Кузнечика
Только
вдумайтесь
Реальный
размер
таблицы
подстановки
Кузнечика
найденной
«псевдослучайным
поиском»
сравним
с
размером
таблицы
AES
(
GolfScript)
у
которого
структура
была
известна
с
самого
начала
Есть
или
нет
бекдор
в
Кузнечике
—
мы
не
знаем
Но
в
том
что
авторы
соврали
—
сомнений
не
осталось
Выводы
Дизайнеры
Кузнечика
неоднократно
декларировали
отсутствие
скрытых
структур
в
важнейшем
элементе
алгоритма
—
SBox
Но
исследования
показали
что
процесс
создания
таблицы
подстановки
был
далёк
от
случайного
поиска
Даже
с
теми
критериями
которые
описали
авторы
в
Если
авторам
верить
(а
по
эту
сторону
границы
им
безоговорочно
верят)
то
они
случайно
наткнулись
на
структуру
размер
которой
в
раза
меньше
чем
сам
SBox
Повторюсь
криптография
—
не
точная
наука
и
достаточно
малейшего
повода
для
сомнения
чтобы
разбудить
в
людях
паранойю
В
данной
ситуации
размер
повода
в
раза
более
чем
достаточный
чтобы
считать
алгоритм
разработанный
в
недрах
наших
прославленных
силовых
структур
очень
подозрительным
Нет
ну
правда
смешно
когда
наши
доблестные
ФСБшники
включают
школьников
и
говорят
что
лет
назад
этот
алгоритм
начинал
разрабатываться
чуть
ли
не
в
свободное
время
поэтому
они
в
итоге
потеряли
и
сиды
и
скорее
всего
программу
которая
генерировала
таблицу
подстановок
Просто
так
получилось
что
side
project
стал
национальным
стандартом
¯\_(ツ)_/¯
Послесловие
Сейчас
в
ISO
идёт
полугодовой
период
исследования
Кузнечика
на
наличие
бекдора
По
его
результатам
будет
принято
решение
о
дальнейшей
судьбе
алгоритма
как
международного
стандарта
Либо
процесс
будет
продлён
еще
на
пол
года
Со
слов
людей
лично
знакомых
с
дизайнерами
Кузнечика
алгоритм
был
разработан
в
то
время
когда
никто
не
требовал
объяснять
почему
SBox
имеет
именно
заданный
ими
вид
Поэтому
никто
не
сохранил
стартовые
значения
для
перебора
Аргумент
как
по
мне
слабоват
На
конференции
я
поговорил
с
автором
Curve
Daniel
J
Bernstein
и
Tanja
Lange
которые
являются
членами
комитета
ISO
по
стандартизации
новых
алгоритмов
Они
сказали
что
предоставлять
сиды
не
обязательно
достаточно
показать
саму
программу
которая
генерировала
этот
злосчастный
SBox
Этого
сделано
до
сих
не
было
и
вероятность
этого
события
не
слишком
большая
Ибо
секрет
Вообще
в
можно
найти
много
интересных
деталей
и
реплик
позволяющих
понять
ход
мыслей
членов
комитета
Что
касается
дальнейшей
судьбы
алгоритма
вероятность
принять
его
как
международный
стандарт
довольно
низкая
Это
признают
как
члены
ISO
так
и
сотрудники
российских
компаний
с
которыми
я
познакомился
на
EuroCrypt
Более
того
по
последним
данным
есть
ненулевая
вероятность
выпиливания
уже
принятого
в
стандарт
хэша
Стрибог
(с
тем
же
SBox)
а
так
же
RFC
в
котором
описан
Кузнечик
Можно
было
бы
создать
новый
правильный
по
всем
канонам
SBox
этим
даже
ради
интереса
занялись
в
одной
из
российских
компаний
(кстати
обещали
результаты
показать)
Но
проблема
в
том
что
в
России
Кузнечик
уже
стандартизирован
реализован
в
железе
и
внедрён
везде
где
только
можно
Замена
Кузнечика
на
Кузнечик
V
обойдется
в
очень
круглую
сумму
Девяностые
и
нулевые
давно
позади
Пора
перестать
создавать
алгоритмы
шифрования
в
подвальных
шарашках
и
говорить
что
«а
кроме
ФСБ
никто
ничего
подобного
создать
в
России
не
может
у
нас
выбора
нет»
Может
хотя
бы
попробовать
конкурс
провести
перед
тем
как
бросаться
такими
словами?
И
не
забывать
что
AES
вообще-то
не
в
США
был
придуман
Может
тогда
у
нас
отпадёт
необходимость
бить
по
рукам
совковых
раздолбаев
которые
находят
место
детским
отмазкам
в
алгоритмах
защищающих
помимо
прочего
гос
тайну
Challenge!
Нужно
написать
реализацию
функции
SBox
Кузнечика
которая
была
бы
по
возможности
еще
меньше
чем
найденная
Лео
и
его
коллегами
Но
пойдут
и
те
что
просто
меньше
байт
Технические
детали
Там
же
несколько
примеров
на
разных
языках
Самым
успешным
—
слава
респект
и
уважуха
за
вклад
в
честную
криптографию
Пока
рекорд
—
байт
на
языке
Stax
Это
меньше
чем
четверть
от
размера
«случайно
найденного»
SBox
Спасибо
за
внимание
Теги:
Хабы:
+
Мы
превращаем
программистов
в
криптографов
Карма
Рейтинг
Алексей
Системный
архитектор
криптоманьяк
Публикации
Лучшие
за
сутки
Похожие
Информация
Сайт
Дата
регистрации
мая
Дата
основания
Численность
–
человек
Местоположение
Украина
Ваш
аккаунт
Разделы
Информация
Услуги
Настройка
языка
©
–
