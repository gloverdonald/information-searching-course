OrangePi
с
Proxmox
/
Хабр
β
часа
назад
OrangePi
с
Proxmox
Средний
мин
Туториал
В
прошлой
статье
()
я
описал
начальную
настройку
загрузчика
для
OrangePI
b
(для
OrangePI
тоже
сработает)
а
так
же
настройку
и
запуск
Proxmox
до
состояния
"оно
запустилось"
Виртуалки
там
я
не
пробовал
и
оказалось
что
они
и
не
работают
без
дополнительных
телодвижений
В
этой
статье
я
опишу
как
настроить
уже
Proxmox
и
довести
до
полностью
работоспособного
состояния
Предполагается
что
из
прошлой
статьи
у
вас
уже
настроен
EDK
II
загрузчик
и
вы
можете
свободно
загружатся
откуда
угодно
а
значит
дело
только
в
том
что
бы
подготовить
образ
и
настроить
proxmox
Этим
и
займемся
В
качестве
базового
дистрибутива
я
выбрал
Armbian
образ
с
названием
/Armbian_
_Orangepi
_bookworm_legacy_
img
xz
тому
есть
несколько
причин
Образ
нужно
подготовить
для
UEFI
загрузки
что
бы
его
EDK
II
легко
увидел
В
прошлой
статье
я
писал
что
SSD
у
меня
подключен
в
USB
порт
на
Orange
PI
b
так
что
я
просто
переткнул
его
в
ноутбук
Так
как
я
пользуюсь
linux
то
просто
в
nautilus
нажал
правую
кнопку
на
образе
и
выбрал
"запись
образа"
после
чего
указал
что
его
надо
записать
на
SSD
Есть
много
способов
залить
образ
на
SSD
диск
После
того
как
образ
записан
на
SSD
нужно
смонтировать
разделы
оттуда
mount
/dev/sde
/mnt/

mount
/dev/sde
/mnt/
С
первого
раздела
надо
все
перенести
на
второй
в
папку
/boot
Там
ядро
с
вышеописанным
модулем
fuse
и
прочие
нужные
для
загрузки
файлы
в
том
числе
папка
dtb
в
которой
лежат
файлы
с
описанием
оборудования
на
вашей
версии
OrangePI
(b)
обратите
внимание
что
нужно
будет
указать
в
grub
cfg
и
armbianEnv
txt
верный
файл
Далее
берем
образ
где
есть
UEFI
загрузчик
например
я
взял
его
с
debian-bookworm-live-arm
hybrid
iso
как
писал
в
прошлой
статье
Копируем
папки
/EFI
и
/boot/grub
с
этого
образа
на
первый
раздел
SSD
диска
который
там
после
записи
туда
armbian
образа
появился
После
чего
нужно
отредактировать
/boot/grub/grub
cfg
сделав
его
таким
search
--no-floppy
--fs-uuid
b
d
f
-
-
-be
-
a
d
b
--set=root
--hint
hd
gpt

devicetree
/boot/dtb/rockchip/rk
s-orangepi-
b
dtb
linux
/boot/Image
root=UUID=b
d
f
-
-
-be
-
a
d
b
ro
rootwait
rootfstype=ext

initrd
/boot/initrd
img-
-legacy-rk
xx
boot
Меню
я
делать
не
стал
Обратите
внимание
что
b
d
f
-
-
-be
-
a
d
b
это
UUID
root
файловой
системы
с
конкретного
образа
armbian
если
у
вас
другой
то
UUID
будет
другой
узнать
его
можно
с
помощью
команды
blkid
или
gparted
Так
же
важно
что
бы
файл
rk
s-orangepi-
b
dtb
был
для
вашей
версии
железа
в
моем
случае
это
именно
b
dtb
в
папке
dtb
много
вариантов
Загрузчик
готов
можно
переходить
к
подготовке
armbian
к
работе
с
proxmox
Для
этого
отредактируем
файлы
armbianEnv
txt
armbian_first_run
txt
template
не
уверен
что
это
обязательно
но
я
сделал
Содержимое
файлов
такое
armbianEnv
txt
Обратите
внимание
что
UUID
и
dtb
нужны
тоже
верные


verbosity=

bootlogo=false
overlay_prefix=rockchip-rk

fdtfile=rockchip/rk
s-orangepi-
b
dtb
rootdev=UUID=b
d
f
-
-
-be
-
a
d
b

rootfstype=ext


armbian_first_run
txt
template

FR_general_delete_this_file_after_completion=

FR_net_ethernet_enabled=

FR_net_wifi_enabled=

FR_net_wifi_ssid='имя
вашего
вайфая'
FR_net_wifi_key='пароль
к
вашему
вайфаю'
FR_net_wifi_countrycode='GB'
FR_net_use_static=

FR_net_static_ip='
'
FR_net_static_mask='
'
FR_net_static_gateway='
'
FR_net_static_dns='
'
Тут
важно
отметить
что
адрес
мне
выдал
мой
роутер
с
DHCP
сервером
и
я
на
нем
закрепил
этот
адрес
сразу
за
MAC
адресом
данной
Orange
PI
b
сетевой
карты
Для
proxmox
важно
что
бы
адреса
были
статические
Но
мы
в
любом
случае
далее
сделам
все
статическим
В
соответствии
с
инструкцией
в
статье
()
редактируем
файл
/etc/hosts
localhost

orangepi
proxmox
com
orangepi

::
localhost
orangepi
ip
-localhost
ip
-loopback
fe
::
ip
-localnet
ff
::
ip
-mcastprefix
ff
::
ip
-allnodes
ff
::
ip
-allrouters
В
этом
файле
тот
же
адрес
имя
хоста
orangepi
оно
такое
по
умолчанию
в
Armbian
При
этом
обязательно
надо
удалить
запись
иначе
вероятно
у
proxmox
будут
проблемы
В
целом
редактирование
этого
файла
обязательная
процедура
без
этого
Proxmox
не
установится
скорее
всего
Переходим
к
файлу
/etc/apt/sources
list
в
него
нужно
добавить
репозиторий
deb
[arch=arm
]
https://mirrors
apqa
cn/proxmox/debian/pve
bookworm
port
Собственно
там
лежит
порт
Proxmox
Так
же
нужно
добавить
в
папку
/etc/apt/trusted
gpg
файл
с
ключом
sudo
curl
https://mirrors
apqa
cn/proxmox/debian/pveport
gpg
-o
/etc/apt/trusted
gpg
d/pveport
gpg
Переходим
к
файлу
/etc/network/interfaces
его
содержимое
source
/etc/network/interfaces
d/*
auto
lo
end

iface
lo
inet
loopback

iface
end
inet
auto
iface
end
inet
static

address


netmask


gateway


Статический
адрес
все
тот
же
что
мне
выдал
роутер
Все
файлы
готовы
Далее
можно
отмонтировать
SSD
и
подключить
его
к
OrangePI
b
EDK
II
найдет
его
сам
или
можно
выбрать
в
его
меню
диск
и
загрузится
с
него
Начальную
настройку
Armbian
описывать
не
буду
она
совсем
простая
После
того
как
Armbian
загружен
нужно
сначала
отключить
NetworkManager
с
ним
у
Proxmox
проблемы
он
сам
рулит
сетевыми
интерфейсами
sudo
systemctl
stop
NetworkManager
service
sudo
systemctl
disable
NetworkManager
service
После
чего
я
перезагрузился
для
надежности
В
силу
вступят
настройки
сетевого
интерфейса
из
/etc/network/interfaces
Далее
обновляем
репозитории
и
устанавливаем
собственно
proxmox
sudo
aptitude
update
sudo
aptitude
install
ifupdown
proxmox-ve
open-iscsi
aptitude
в
процессе
разрешит
конфликты
в
зависимостях
и
предложит
удалить
пакет
vlan
я
согласился
После
чего
Proxmox
был
благополучно
установлен
на
OrangePI
b
Если
будут
проблемы
с
установкой
установочные
скрипты
proxmox
не
показывают
ошибок
их
нужно
смотреть
через
sudo
journalctl
-b
Но
это
еще
не
все
Если
не
откатить
пакет
с
прошивками
то
виртуалки
работать
не
станут
просто
будут
грузить
CPU
на
%
и
висеть
apt
download
pve-edk
-firmware-aarch
=
-rockchip
dpkg
-i
pve-edk
-firmware-aarch
_
-rockchip_all
deb
После
того
как
это
сделано
можно
перезагрузить
девайс
и
с
ноутбука
зайти
в
консоль
по
адресу
конкретный
айпишник
у
вас
будет
свой
конечно
же
Логопас
такой
же
для
рута
как
вы
задали
при
настройке
Armbian
На
этом
настройка
еще
не
завершена
Нужно
создать
bridge
а
так
как
теперь
proxmox
рулит
в
/etc/network/interfaces
настройками
сети
а
за
счет
ifupdown
девайс
для
смены
настроек
не
надо
перегружать
то
в
консоли
надо
сначала
удалить
IP
и
Gateway
у
интерфеса
end
(см
Datacenter->orangepi
->System->Network)
не
применяя
настроек
это
очень
важно
иначе
сеть
отвалится
кнопку
Apply
Configuration
нажимать
нельзя!
После
чего
нужно
создать
Linux
Bridge
задав
ему
тот
же
адрес
что
выдал
вам
роутер
гейт
(которые
вы
отняли
у
end
)
и
Bridge
ports
end
Вот
только
потом
можно
нажать
Apply
Configuration
и
оба
действия
будут
выполнены
вместе
на
стороне
OrangePI
b
С
этого
момента
у
вас
в
консоли
появится
два
сетевых
интерфейса
как
на
картинке
Далее
создадим
первую
виртуалку
ее
тоже
надо
настроить
строго
определенным
образом
()
Сначала
закачаем
iso
дистра
который
хотим
поставить
Разберетесь
как
в
proxmox
заливать
данные
в
хранилище
В
моем
случае
это
ubuntu-
-live-server-arm
iso
Потом
создаем
виртуальную
машину
указав
что
в
CD
привод
надо
этот
образ
воткнуть
Обратите
внимание
что
когда
грузить
его
будете
надо
подождать
он
стартует
долго
Другие
настройки
виртуальной
машины
на
картинке
Тут
важно
отметить
что
если
вы
собираетесь
использовать
несколько
ядер
в
виртуалке
то
нужно
указать
к
каким
ядрам
rk
s
привязать
эту
виртуалку
как
на
картинке
там
видно
что
я
выбрал
ядра
и
указал
что
виртуальные
ядра
надо
привязать
к
физическим
ядрам
процессора
из
диапазона
-
Дело
в
том
что
ядра
в
SoC
разного
типа
одни
мощные
вторые
нет
и
нельзя
запустить
виртуалку
на
одном
мощном
а
втором
слабом
так
что
обязательно
надо
указать
affinity
Для
одноядерных
виртуалок
это
не
нужно
Все
можно
запускать
виртуалку
и
ставить
ubuntu
в
ней
Теперь
не
придется
по
сто
раз
переставлять
дистр
есть
снапшеты
и
множество
прочих
удобств
для
того
что
бы
не
мусорить
в
одном
дистре
чем
попало
Теги:
Хабы:
Карма
Рейтинг
Ренат
Ескенин
Программист
Java
->
Spring/JavaEE/Android
Публикации
Лучшие
за
сутки
Похожие
Истории
Ближайшие
события
–
февраля
:
Онлайн
–
февраля
Онлайн
февраля
:
Онлайн
–
февраля
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
марта
–
апреля
:
Онлайн
–
марта
:
–
:
Москва
•
Онлайн
марта
:
–
:
Москва
•
Онлайн
Ваш
аккаунт
Разделы
Информация
Услуги
Настройка
языка
©
–
