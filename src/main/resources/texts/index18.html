Установка
виртуальных
машин
KVM
под
ubuntu
server
/
Хабр
β
окт
в
:
Установка
виртуальных
машин
KVM
под
ubuntu
server
мин
K
Последнее
время
применение
виртуализации
при
построении
серверной
инфраструктуры
встречается
все
чаще
Гибкость
масштабируемость
экономия
делают
эту
технологию
очень
перспективной
Сейчас
на
рынке
существует
достаточное
количество
решений
как
проприетарных
так
и
open
source
позволяющих
развернуть
виртуальные
сервера
Один
из
таких
вариантов
я
хочу
рассмотреть
в
данной
статье
Поигравшись
с
ГУЙовыми
платформами
виртуализации
от
Microsoft
VMware
и
Sun
я
решил
попробовать
сделать
тоже
самое
через
консоль
Установив
давно
понравившийся
мне
linux
дистрибутив
ubuntu
стал
выбирать
—
на
какой
же
реализации
виртуальных
машин
(ВМ)
остановиться
В
википедии
есть
интересная
хотя
посмотрев
оффициальный
к
ubuntu
я
понял
что
лучше
начать
с
KVM
Процедура
установки
хост-сервера
в
общем-то
стандартная
но
есть
нюансы
Во
время
установки
включил
LVM
(как
я
понял
—
гостевые
ОС
можно
впоследстии
размещать
на
LVM-томах
что
придаст
дополнительную
гибкость)
а
в
окне
выбора
доустанавлемого
ПО
отметил
OpenSSH
server
и
Virtual
Machine
host
Хост-серверу
задан
статический
ip
что
можно
увидеть
далее
в
приведенных
конфигах
После
установки
хост-сервера
подключаемся
к
нему
по
ssh
(одноименной
командой
из
linux
или
putty/kitty
из
windows)
Первым
делом
необходимо
проверить
поддерживает
ли
железо
сервера
аппаратную
виртуализацию
командой
egrep
'(vmx|svm)'
/proc/cpuinfo
Если
вывод
команды
не
пустой
значит
поддерживает
Скачиваем
в
домашнюю
папку
iso-образ
того
дистрибутива
операционной
системы
которая
в
последствии
будет
гостевой
У
меня
это
тот
же
самый
ubuntu-
-server-amd
iso
Устанавливаем
необходимые
пакеты:
sudo
apt-get
install
kvm
libvirt-bin
python-virtinst
bridge-utils
Добавляем
пользователя
который
будет
рулить
виртуалками
(в
простейшем
случае
это
тот
пользователь
которого
мы
завели
во
время
установки
системы
и
под
которым
проделываем
все
описываемые
действия):
sudo
adduser
$USER
libvirtd
После
этого
лучше
ребутнуться
Проверяем
как
установилась
KVM
командой:
virsh
-c
qemu:///system
list
--all
В
консоли
должно
появиться
примерно
следующее:
az@vsrvs:~$
virsh
-c
qemu:///system
list
--all
Connecting
to
uri:
qemu:///system
Id
Name
State
----------------------------------
если
все
так
продолжаем
Для
того
чтобы
виртуальные
сервера
работали
в
нашей
реальной
локальной
сети
на
хост-машине
создаем
сетевой
мост
Для
этого
надо
подредактировать
файл
/etc/network/interfaces
Так
он
выглядел
до
модификации:
#
This
file
describes
the
network
interfaces
available
on
your
system
#
and
how
to
activate
them
For
more
information
see
interfaces(
)


#
The
loopback
network
interface
auto
lo
iface
lo
inet
loopback

#
The
primary
network
interface
auto
eth

iface
eth
inet
static

address


netmask


network


broadcast


gateway


Так
после:
#
This
file
describes
the
network
interfaces
available
on
your
system
#
and
how
to
activate
them
For
more
information
see
interfaces(
)


#
The
loopback
network
interface
auto
lo
iface
lo
inet
loopback

#
The
primary
network
interface
auto
eth

iface
eth
inet
manual

auto
br

iface
br
inet
static

address


netmask


network


broadcast


gateway


bridge_ports
eth


bridge_fd


bridge_hello


bridge_maxage


bridge_stp
off

Далее
переходим
к
инсталляции
ВМ:
sudo
virt-install
-n
vsrv
-r
-f
vsrv
img
-s
-c
ubuntu-
-server-amd
iso
--accelerate
--os-type=linux
--os-variant=generic
-v
--vnc
-w
bridge:br
где:
-n
vsrv
—
имя
ВМ;
-r
—
выделяемый
объем
ОЗУ
для
нее;
-f
vsrv
img
—
файл
являющийся
виртуальный
жестким
диском
для
гостевой
ОС;
-s
—
объем
этого
диска
в
гигабайтах;
-c
ubuntu-
-server-amd
iso
—
образ
cd
дистрибутива
гостевой
ОС
подключаемый
как
виртуальный
cdrom;
--accelerate
--os-type=linux
--os-variant=generic
-v
—
ускоряем
оптимизируем
ВМ
для
конкретной
гостевой
ОС
и
задействуем
аппаратные
возможности
виртуализации;
--vnc
—
запускаем
для
ВМ
vnc-сервер;
-w
bridge:br
—
указываем
использовать
сетевой
мост
Если
после
запуска
этой
команды
не
появилось
никаких
ошибок
а
отобразилось
нечто
следующее:
Starting
install…
Creating
domain…
B
:
/usr/lib/python
/dist-packages/virtinst/Guest
py:
:
DeprecationWarning:
integer
argument
expected
got
float
for
ignore
in
range(
(
/
)):
#
seconds
second
sleeps
Unable
to
connect
to
graphical
console:
virt-viewer
not
installed
Please
install
the
'virt-viewer'
package
Domain
installation
still
in
progress
You
can
reconnect
to
the
console
to
complete
the
installation
process
То
все
отлично
виртуальная
машина
запустилась
что
можно
проверить
командой:
virsh
-c
qemu:///system
list
--all
Поэтому
преступаем
к
установке
гостевой
ОС
Для
начала
необходимо
подключится
к
vnc-серверу
который
отображает
экран
ВМ
Я
делал
это
из
WinXP
хотя
из
практически
любого
linux
дистрибутива
это
делается
аналогично
Устанавливаем
(если
в
самом
начале
не
установили
а
настраивали
сервер
локально)
ssh-клиент
например
(доработанный
вариант
putty)
Запускаем
настраиваем:
Примечание
При
запуске
еще
одной
ВМ
порт
vnc-сервера
увеличится
на
поэтому
для
того
чтобы
увидеть
ее
экран
необходимо
сделать
перенаправление
порта
хост-сервера
на
например
порт
Устанавливаем
vnc-клиент
например
запускаем
UltraVNC
Viewer
и
подключаемся
к
localhost:
Если
все
сделано
правильно
то
мы
увидим
экран
нашей
ВМ
с
запущенным
инсталлятором
гостевой
ОС
Устанавливаем
гостевую
ОС
Так
она
начинает
загружаться
после
установки:
После
установки
и
настройки
гостевой
ОС
ВМ
можно
клонировать
командой
sudo
virt-clone
-o
vsrv
-n
vsrv
-f
vsrv
img
--connect=qemu:///system
UPD:
После
клонирования
для
того
чтобы
заработал
сетевой
интерфейс
необходимо
на
клоне
удалить
файл
/etc/udev/rules
d/
-persistent-net
rules
ну
и
заодно
изменить
в
/etc/hostname
и
в
/etc/hosts
имя
сервера
на
новое
TIP:
Команды
для
управления
ВМ:
Использованные
материалы:
Теги:
Хабы:
+
Карма
Рейтинг
Антон
Завьялов
Пользователь
Публикации
Лучшие
за
сутки
Похожие
Истории
Работа
вакансий
Ближайшие
события
–
февраля
:
Онлайн
–
февраля
Онлайн
февраля
:
Онлайн
–
февраля
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
февраля
:
Онлайн
марта
–
апреля
:
Онлайн
–
марта
:
–
:
Москва
•
Онлайн
марта
:
–
:
Москва
•
Онлайн
Ваш
аккаунт
Разделы
Информация
Услуги
Настройка
языка
©
–
